<div class="simple-calendar max-w-7xl mx-auto bg-white rounded-2xl shadow-md border border-neutral-200 p-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <time
      datetime="<%= start_date.strftime('%Y-%m') %>"
      class="text-2xl font-bold text-brand"
    >
      <%= t('date.month_names')[start_date.month] %> <%= start_date.year %>
    </time>
    <nav class="flex items-center gap-2 text-sm">
      <%= link_to t('simple_calendar.previous', default: 'Previous'),
        calendar.url_for_previous_view,
        class: "px-4 py-2 rounded-lg border border-neutral-300 hover:bg-neutral-100" %>

      <%= link_to t('simple_calendar.today', default: 'Today'),
        calendar.url_for_today_view,
        class: "px-4 py-2 rounded-lg bg-brand text-black font-medium hover:underline" %>

      <%= link_to t('simple_calendar.next', default: 'Next'),
        calendar.url_for_next_view,
        class: "px-4 py-2 rounded-lg border border-neutral-300 hover:bg-neutral-100" %>
    </nav>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full table-fixed border-separate border-spacing-2">
      <thead>
        <tr>
          <% date_range.slice(0, 7).each do |day| %>
            <th class="py-2 text-center text-sm font-semibold text-neutral-600">
              <%= t('date.abbr_day_names')[day.wday] %>
            </th>
          <% end %>
        </tr>
      </thead>

      <tbody>
        <% date_range.each_slice(7) do |week| %>
          <tr>
            <% week.each do |day| %>
              <% 
                is_past = day < Date.current
                is_today = day == Date.current
                
                has_available_slots = TimeslotXTable.joins(:timeslot).where(timeslots: { date: day }, status: 'available').exists?

                user_reservations = current_user ? current_user.reservations.joins(timeslot_x_table: :timeslot).where(timeslots: { date: day }) : []
                has_user_reservation = user_reservations.exists?

                user_reservation_info = if current_user
                  current_user.reservations
                    .joins(timeslot_x_table: [:timeslot, :table])
                    .where(timeslots: { date: day })
                    .map { |res| { time: res.timeslot_x_table.timeslot.start_time.strftime("%H:%M"), table_no: res.timeslot_x_table.table.table_no } }
                else
                  []
                end

                has_user_reservation = user_reservation_info.any?
              %>
              
              <%= content_tag :td, class: "h-full align-middle" do %>
                <div 
                  data-date="<%= day.iso8601 %>"
                  onclick="getTimeslot(this.dataset.date, <%= user_reservation_info.to_json %>)"
                  class="
                  h-full rounded-xl p-3 border hover:bg-amber-200 transition cursor-pointer
                  <%= 'bg-brand/10 border-brand' if is_today && !has_user_reservation %>
                  <%= 'bg-neutral-50 border-neutral-200' if !is_today && !has_user_reservation && !has_available_slots %>
                  <%= 'opacity-50 pointer-events-none' if is_past %>
                  <%= 'bg-purple-400/30 border-purple-500' if has_user_reservation %>
                  <%= 'bg-green-300/30 border-green-500' if !has_user_reservation && has_available_slots %>
                  ">
                  <div 
                    class="text-xs font-semibold text-center align-middle
                    <%= is_today ? 'text-brand' : 'text-neutral-500' %>">
                    <%= day.day %>
                  </div>
                </div>
              <% end %>
            <% end %>
          </tr>
        <% end %>
      </tbody>

    </table>
  </div>

  <div id="calendar-legends" class="flex justify-around items-center mt-5">
      <div class="flex flex-row space-x-2 items-center">
        <div class="bg-green-300 rounded-full w-5 h-5"></div>
        <span>Slots are available!</span>
      </div>
      <div class="flex flex-row space-x-2 items-center">
        <div class="bg-purple-400 rounded-full w-5 h-5"></div>
        <span>You have a reservation!</span>
      </div>
    </div>

</div>
